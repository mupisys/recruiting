{% extends "base.html" %}
{% block title %}Mensagens{% endblock %}
{% block content %}

<main class="mx-auto w-full max-w-5xl px-4 py-8 pt-20 lg:pt-30 lg:py-10">
  <!-- Header -->
  <header class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">Mensagens</h1>
      <p class="text-sm text-muted-foreground">
        Filtre por status e pesquise por nome ou e-mail.
      </p>
    </div>

    <button
      type="button"
      class="btn btn-danger w-full sm:w-auto"
      @click="$dispatch('confirm', {
        title: 'Sair',
        text: 'Tem certeza que deseja sair?',
        action: '{% url 'logout_confirm' %}'
      })"
    >
      Sair
    </button>
  </header>

  <!-- Filtros + Busca -->
  <section
    class="rounded-2xl border border-border bg-card/70 backdrop-blur shadow-sm"
    x-data="{
      status: '{{ status }}',
      clearAndRefresh() {
        this.$refs.q.value = '';

        htmx.ajax(
          'GET',
          '{% url 'messages_list' %}?status=' + this.status,
          { target: '#messages-container', swap: 'innerHTML' }
        );

        history.replaceState(
          null,
          '',
          '{% url 'messages_list' %}?status=' + this.status
        );

        this.$nextTick(() => this.$refs.q.focus());
      }
    }"
  >
    <div class="p-4 sm:p-5">
      <form id="filters-form" class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
        <input type="hidden" name="status" x-model="status" />

        <!-- Busca -->
        <div class="relative w-full lg:max-w-md">
          <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
            <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 21l-4.3-4.3"/>
              <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"/>
            </svg>
          </span>

          <input
            x-ref="q"
            id="q"
            name="q"
            value="{{ q }}"
            placeholder="Buscar por nome ou email..."
            class="w-full rounded-xl border border-input bg-background pl-11 pr-24 py-2.5 text-sm
                   placeholder:text-muted-foreground/80
                   focus-visible:ring-2 focus-visible:ring-ring/50"
            hx-get="{% url 'messages_list' %}"
            hx-trigger="keyup changed delay:400ms"
            hx-target="#messages-container"
            hx-swap="innerHTML"
            hx-include="#filters-form"
            hx-push-url="true"
          />

          <button
            type="button"
            class="btn btn-ghost absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1.5"
            @click="clearAndRefresh()"
          >
            Limpar
          </button>
        </div>

        <!-- Chips de status -->
        <div class="flex flex-wrap gap-2">
          <button
            type="button"
            class="btn px-3 py-2"
            :class="status === 'all' ? 'bg-primary text-primary-foreground' : 'btn-ghost'"
            @click="status='all'"
            hx-get="{% url 'messages_list' %}"
            hx-target="#messages-container"
            hx-swap="innerHTML"
            hx-include="#filters-form"
            hx-push-url="true"
          >
            Todas
          </button>

          <button
            type="button"
            class="btn px-3 py-2"
            :class="status === 'unread' ? 'bg-primary text-primary-foreground' : 'btn-ghost'"
            @click="status='unread'"
            hx-get="{% url 'messages_list' %}"
            hx-target="#messages-container"
            hx-swap="innerHTML"
            hx-include="#filters-form"
            hx-push-url="true"
          >
            NÃ£o lidas
          </button>

          <button
            type="button"
            class="btn px-3 py-2"
            :class="status === 'read' ? 'bg-primary text-primary-foreground' : 'btn-ghost'"
            @click="status='read'"
            hx-get="{% url 'messages_list' %}"
            hx-target="#messages-container"
            hx-swap="innerHTML"
            hx-include="#filters-form"
            hx-push-url="true"
          >
            Lidas
          </button>
        </div>
      </form>
    </div>

    <!-- Lista -->
    <div class="border-t border-border">
      <div
        id="messages-container"
        class="p-4 sm:p-5"
        hx-indicator="#messages-loading"
      >
        {% include "partials/messages_ul.html" %}
      </div>

      <!-- Loading do HTMX -->
      <div id="messages-loading" class="hidden p-4 sm:p-5">
        <div class="flex items-center gap-3 text-sm text-muted-foreground">
          <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"/>
            <path class="opacity-80" d="M22 12a10 10 0 0 0-10-10" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
          </svg>
          Carregando mensagens...
        </div>
      </div>
    </div>
  </section>
</main>

{% endblock %}
