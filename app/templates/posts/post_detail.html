{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Detalhes do Post - Heritage Auto{% endblock %}

{% block content %}
<div class="min-h-screen pt-24 pb-12 px-4" x-data="postDetail({{ view.kwargs.pk }})">
    <div class="max-w-4xl mx-auto">
        <!-- Loading State -->
        <div x-show="loading" class="text-center py-20">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary"></div>
        </div>

        <div x-show="!loading && post" style="display: none;">
            <!-- Post Card -->
            <div class="bg-card border border-white/10 rounded-lg shadow-2xl overflow-hidden mb-8" data-aos="fade-up">
                <!-- Media -->
                <template x-if="post.image">
                    <div class="w-full h-96 overflow-hidden">
                        <img :src="post.image" class="w-full h-full object-cover" :alt="post.title">
                    </div>
                </template>
                <template x-if="post.video">
                    <div class="w-full bg-black aspect-video">
                        <video controls class="w-full h-full">
                            <source :src="post.video" type="video/mp4">
                        </video>
                    </div>
                </template>

                <div class="p-8">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-6">
                        <h1 class="text-4xl font-black italic uppercase text-white" x-text="post.title"></h1>
                        <div class="flex gap-2">
                            <span class="bg-primary text-black text-xs font-bold px-2 py-1 rounded uppercase" x-show="post.is_official">Oficial</span>
                            <span class="bg-gray-700 text-white text-xs font-bold px-2 py-1 rounded uppercase" x-text="post.category ? post.category.name : ''"></span>
                        </div>
                    </div>

                    <!-- Meta -->
                    <div class="flex items-center gap-4 text-sm text-muted mb-8 border-b border-white/10 pb-6">
                        <span>Por <strong class="text-white" x-text="post.author"></strong></span>
                        <span>&bull;</span>
                        <span x-text="formatDate(post.created_at)"></span>
                    </div>

                    <!-- Content -->
                    <div class="prose prose-invert max-w-none mb-8 text-gray-300 whitespace-pre-line" x-text="post.content"></div>

                    <!-- Actions -->
                    <div class="flex items-center gap-6 pt-6 border-t border-white/10">
                        <button @click="likePost()" class="flex items-center gap-2 text-muted hover:text-primary transition-colors group">
                            <i class="bi" :class="post.is_liked ? 'bi-heart-fill text-primary' : 'bi-heart group-hover:text-primary'"></i>
                            <span x-text="post.likes_count + ' Curtidas'"></span>
                        </button>
                        <div class="flex items-center gap-2 text-muted">
                            <i class="bi bi-chat-dots"></i>
                            <span x-text="comments.length + ' Comentários'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="bg-card border border-white/10 rounded-lg shadow-xl p-8" data-aos="fade-up" data-aos-delay="100">
                <h3 class="text-2xl font-bold uppercase mb-8 border-b border-primary inline-block pr-4">Conversa no Pit Lane</h3>

                <!-- Comment Form -->
                <div class="mb-10">
                    {% if user.is_authenticated %}
                    <form @submit.prevent="submitComment">
                        <div class="mb-4">
                            <textarea x-model="newComment" rows="3" class="w-full bg-black/50 border border-white/20 rounded p-3 text-white focus:border-primary focus:outline-none transition-colors" placeholder="Participe da discussão..." required></textarea>
                        </div>
                        <button type="submit" class="bg-primary text-black font-bold uppercase py-2 px-6 hover:bg-white transition-colors text-sm" :disabled="submittingComment">
                            <span x-show="!submittingComment">Postar Comentário</span>
                            <span x-show="submittingComment">Postando...</span>
                        </button>
                    </form>
                    {% else %}
                    <div class="bg-white/5 p-4 rounded border border-white/10 text-center">
                        <p class="text-muted mb-2">Faça login para participar da conversa.</p>
                        <a href="{% url 'login' %}" class="text-primary font-bold hover:text-white uppercase text-sm">Login Agora</a>
                    </div>
                    {% endif %}
                </div>

                <!-- Comments List -->
                <div class="space-y-6">
                    <template x-for="comment in comments" :key="comment.id">
                        <div class="bg-black/30 p-4 rounded border border-white/5">
                            <div class="flex justify-between items-center mb-2">
                                <strong class="text-white text-sm" x-text="comment.author"></strong>
                                <small class="text-muted text-xs" x-text="timeSince(comment.created_at) + ' atrás'"></small>
                            </div>
                            <p class="text-gray-400 text-sm mb-3" x-text="comment.content"></p>
                            
                            <!-- Reply Button -->
                            <div class="flex items-center gap-4 mb-3">
                                <button @click="replyToId = (replyToId === comment.id ? null : comment.id)" class="text-xs text-muted hover:text-primary uppercase font-bold flex items-center gap-1">
                                    <i class="bi bi-reply-fill"></i> Responder
                                </button>
                            </div>

                            <!-- Reply Form -->
                            <div x-show="replyToId === comment.id" class="mb-4 pl-4 border-l-2 border-primary" x-transition>
                                <form @submit.prevent="submitReply(comment.id)">
                                    <textarea x-model="replyContent" rows="2" class="w-full bg-black/50 border border-white/20 rounded p-2 text-white text-sm focus:border-primary focus:outline-none mb-2" placeholder="Escreva uma resposta..." required></textarea>
                                    <div class="flex justify-end gap-2">
                                        <button type="button" @click="replyToId = null" class="text-xs text-muted hover:text-white uppercase font-bold px-3 py-1">Cancelar</button>
                                        <button type="submit" class="bg-primary text-black text-xs font-bold uppercase px-4 py-1 rounded hover:bg-white transition-colors" :disabled="submittingReply">Responder</button>
                                    </div>
                                </form>
                            </div>

                            <!-- Replies -->
                            <div class="pl-6 border-l border-white/10 space-y-4 mt-4" x-show="comment.replies && comment.replies.length > 0">
                                <template x-for="reply in comment.replies" :key="reply.id">
                                    <div class="bg-white/5 p-3 rounded">
                                        <div class="flex justify-between items-center mb-1">
                                            <strong class="text-white text-xs" x-text="reply.author"></strong>
                                            <small class="text-muted text-[10px]" x-text="timeSince(reply.created_at) + ' atrás'"></small>
                                        </div>
                                        <p class="text-gray-400 text-xs" x-text="reply.content"></p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                    <div x-show="comments.length === 0" class="text-center text-muted py-4">
                        <p>Nenhum comentário ainda. Seja o primeiro a comentar!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'posts/post_detail.js' %}"></script>
{% endblock %}
